function initMap(){var e=cleanMapStyle(),t={lat:-23.5505,lng:-46.6333},o=new google.maps.DirectionsService,n=new google.maps.DirectionsRenderer,i=new google.maps.Map(document.getElementById("basic_map"),{zoom:13,center:t,styles:e});n.setMap(i);var s=new google.maps.Marker({title:"Voc\xea",position:t,optimized:!1,zIndex:99999999});initializeUserPos(i,s),myPosListener(i,s),s.addListener("position_changed",function(){""!=lastDest&&getDistance(s,lastDest)<200&&(lastDest="",n.set("directions",null),changeOpacity(undefined,1),$("#routeFreeSlot").html('<span class="glyphicon glyphicon-map-marker"></span> Guardar Bike'))}),addStations(i,s),i.setCenter(t);var a=document.getElementById("legend");i.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(a),updLocs(i,s),updStations(i),freeSlotsListener(o,n),freeBikesListener(o,n)}function addStations(e){$.getJSON("https://api.citybik.es/v2/networks/bikesampa",function(t){t=t.network.stations;var o={lat:[],lng:[],img:[],name:[],free:[],emptyS:[]};t.forEach(function(e){var t=0==e.free_bikes?"/assets/badBike.png":"/assets/okBike.png";o.lat.push(e.latitude),o.lng.push(e.longitude),o.img.push(t),o.name.push(e.name),o.free.push(e.free_bikes),o.emptyS.push(e.empty_slots)}),addCicloSampa(e,o)})}function addCicloSampa(e,t){$.getJSON("https://api.citybik.es/v2/networks/ciclosampa",function(o){o=o.network.stations,o.forEach(function(e){var o=0==e.free_bikes?"/assets/badBike.png":"/assets/okBike.png";t.lat.push(e.latitude),t.lng.push(e.longitude),t.img.push(o),t.name.push(e.name),t.free.push(e.free_bikes),t.emptyS.push(e.empty_slots)}),setMarkers(e,t)})}function setMarkers(e,t){""==infowindow&&(infowindow=new google.maps.InfoWindow({content:""}));for(var o=0;o<t.name.length;o++){var n=new google.maps.Marker({map:e,title:t.name[o],icon:t.img[o],position:new google.maps.LatLng(t.lat[o],t.lng[o])}),i=createInfo(t,o);bindInfoWindow(n,e,infowindow,i),stations.push(n)}}function bindInfoWindow(e,t,o,n){google.maps.event.addListener(e,"click",function(){o.setContent(n),o.open(t,e)})}function createInfo(e,t){var o=1!=e.free[t]?" bikes livres":" bike livre",n=1!=e.emptyS[t]?" slots livres":" slot livre",i=e.free[t]>2?"green":"red";return"<h3>"+e.name[t]+'</h3><p><font size="3" color="'+i+'"><b>'+e.free[t]+o+'</b></font><br><font size="3" color="MidnightBlue"><b>'+e.emptyS[t]+n+"</b><br></p>"}function updStations(e){setInterval(function(){getAPIinfo(e)},1e4)}function getAPIinfo(e){$.getJSON("https://api.citybik.es/v2/networks/bikesampa",function(t){t=t.network.stations;var o={lat:[],lng:[],img:[],name:[],free:[],emptyS:[]};t.forEach(function(e){var t=0==e.free_bikes?"/assets/badBike.png":"/assets/okBike.png";o.img.push(t),o.name.push(e.name),o.free.push(e.free_bikes),o.emptyS.push(e.empty_slots)}),getCicloSampa(o,e)})}function getCicloSampa(e,t){$.getJSON("https://api.citybik.es/v2/networks/ciclosampa",function(o){o=o.network.stations,o.forEach(function(t){var o=0==t.free_bikes?"/assets/badBike.png":"/assets/okBike.png";e.img.push(o),e.name.push(t.name),e.free.push(t.free_bikes),e.emptyS.push(t.empty_slots)}),updMarkers(e,t)})}function updMarkers(e,t){if(stations.length>0)for(var o=0;o<stations.length;o++){var n=stations[o];if(e.free[o]!=undefined){n.setIcon(0==e.free[o]?"/assets/badBike.png":"/assets/okBike.png");var i=createInfo(e,o);bindInfoWindow(n,t,infowindow,i)}}}function initializeUserPos(e,t){getGeoLocation(),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(o){var n=new google.maps.LatLng(o.coords.latitude,o.coords.longitude);t.setPosition(n),t.setMap(e),e.setCenter(n)})}function updLocs(e,t){setInterval(function(){getGeoLocation(),""==pos||t.getPosition().lat()==pos.coords.latitude&&t.getPosition().lng()==pos.coords.longitude||(t.setPosition(new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude)),t.getMap()!=e&&t.setMap(e))},15e3)}function getGeoLocation(){navigator.geolocation&&(navigator.geolocation.getCurrentPosition(setGeoCookie),navigator.geolocation.getCurrentPosition(displayCurrLoc))}function setGeoCookie(e){var t=e.coords.latitude+"|"+e.coords.longitude;document.cookie="lat_lng="+escape(t)}function displayCurrLoc(e){pos=e}function getUserPos(){return""!=pos?pos:undefined}function freeSlotsListener(e,t){$("#routeFreeSlot").click(function(){getFreeSlotBike("slot",e,t)})}function freeBikesListener(e,t){$("#routeFreeBike").click(function(){getFreeSlotBike("bike",e,t)})}function getFreeSlotBike(e,t,o){if(""!=lastDest)return lastDest="",o.set("directions",null),changeOpacity(undefined,1),$("#routeFreeSlot").html('<span class="glyphicon glyphicon-map-marker"></span> Guardar Bike'),void(document.getElementById("routeFreeBike").style.display="inline");var n=document.getElementById("travelMode").value;pos!=undefined&&""!=pos?$.ajax({url:"/api/free_slots_bikes.json",data:{pos:pos,query:e},dataType:"json"}).done(function(e){e.success?(destination=obtainStation(e.destStation),destination!=undefined&&(calculateAndPlot(t,o,destination,n),changeOpacity(destination,.5)),$("#routeFreeSlot").html('<span class="glyphicon glyphicon-ban-circle"></span> Apagar rota'),document.getElementById("routeFreeBike").style.display="none"):window.alert("N\xe3o h\xe1 esta\xe7\xf5es com slots livres! D:")}):window.alert("Precisamos da sua posi\xe7\xe3o...")}function calculateAndPlot(e,t,o,n){e.route({origin:new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude),destination:o.getPosition(),travelMode:n},function(e,n){"OK"===n?(t.setDirections(e),lastDest=o):window.alert("Houve falha no c\xe1lculo da rota devido a "+n)})}function obtainStation(e){for(var t=0;t<stations.length;t++)if(st=stations[t],e==st.getTitle())return st;return undefined}function getDistance(e,t){return s=e.getPosition(),d=t.getPosition(),google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(s.lat(),s.lng()),new google.maps.LatLng(d.lat(),d.lng()))}function cleanMapStyle(){return[{featureType:"administrative.land_parcel",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi",elementType:"labels.text",stylers:[{visibility:"off"}]},{featureType:"poi.business",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"road.local",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]}]}function changeOpacity(e,t){e==undefined?thisName="":thisName=e.getTitle();for(var o=0;o<stations.length;o++){var n=stations[o];n.getTitle()!=thisName&&n.setOpacity(t)}}function myPosListener(e,t){$("#myPosition").click(function(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(o){var n=new google.maps.LatLng(o.coords.latitude,o.coords.longitude);t.setPosition(n),t.getMap()!=e&&t.setMap(e),e.setCenter(n)})})}var stations=[],pos="",infowindow="",lastDest="";getGeoLocation(),window.google?initMap():$.ajax("//maps.google.com/maps/api/js?key=AIzaSyBaPMPea6wsfaG4aAfW1LCMX5CeE1rvy-0&callback=initMap",{crossDomain:!0,dataType:"script"});